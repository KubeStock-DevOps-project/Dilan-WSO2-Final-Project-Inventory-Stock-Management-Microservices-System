# Supplier Profile 404 Error - Debugging Guide

## Issue
`GET http://localhost:3004/api/suppliers/profile/me` returns 404 (Not Found)

## Root Cause Analysis

Based on the logs, the issue is **JWT token malformation**:
```
JsonWebTokenError: jwt malformed
```

## Why This Happens

1. **Invalid Token Format**: The token stored in `localStorage` is not a valid JWT
2. **Missing Token Parts**: JWT should have 3 parts separated by dots (header.payload.signature)
3. **Corrupted Token**: Token may have been corrupted during storage or retrieval

## Verification Steps

### Step 1: Check Your Token
Open browser console (F12) and run:
```javascript
const token = localStorage.getItem("token");
console.log("Token:", token);

// Check JWT structure
if (token) {
  const parts = token.split(".");
  console.log("Token parts count:", parts.length); // Should be 3
  if (parts.length === 3) {
    try {
      const payload = JSON.parse(atob(parts[1]));
      console.log("Token payload:", payload);
    } catch (e) {
      console.error("Cannot decode token:", e);
    }
  } else {
    console.error("Invalid JWT structure - should have 3 parts!");
  }
}
```

### Step 2: Test the API
Use the test script in `frontend/scripts/test-supplier-api.js`:
```javascript
// Copy the entire content of test-supplier-api.js into browser console
// Then run:
testSupplierAPI()
```

### Step 3: Check Backend Logs
```powershell
docker logs supplier-service --tail=50
```

Look for:
- `jwt malformed` - Token is invalid
- `401 Unauthorized` - Authentication failed
- `404 Not Found` - Route or supplier not found

## Solutions

### Solution 1: Clear Token and Re-login (Recommended)
```javascript
// In browser console:
localStorage.clear();
location.reload();
// Then login again
```

### Solution 2: Manual Token Verification
1. Login through the UI
2. Open DevTools → Network tab
3. Look for the login request
4. Check the response for the `token` field
5. Verify it's a valid JWT format

### Solution 3: Check User Service Response
The token is generated by the user-service. Check if it's returning a proper JWT:
```powershell
docker logs user-service --tail=50
```

### Solution 4: Verify Supplier Association
The supplier profile endpoint requires:
1. Valid JWT token
2. User must be logged in
3. User's ID must correspond to a supplier in the `suppliers` table

Check if your user account has a supplier profile:
```sql
-- Connect to supplier_db
SELECT * FROM suppliers WHERE id = YOUR_USER_ID;
```

## Common Scenarios

### Scenario 1: Token is Null/Undefined
**Issue**: No token in localStorage
**Solution**: User needs to login

### Scenario 2: Token is Not a JWT
**Issue**: Token doesn't have 3 parts (xxx.yyy.zzz)
**Solution**: Clear localStorage and re-login

### Scenario 3: Token is Expired
**Issue**: Token exists but is no longer valid
**Solution**: Implement token refresh or force re-login

### Scenario 4: User is Not a Supplier
**Issue**: User account exists but has no supplier profile
**Solution**: 
- Verify user role is "supplier"
- Ensure supplier record exists in `suppliers` table
- User ID should match supplier ID

## Enhanced Error Handling

The component now includes:
- ✅ Token existence check
- ✅ Detailed HTTP status code handling
- ✅ Specific error messages for different scenarios
- ✅ Console logging for debugging
- ✅ Automatic token removal on 401 errors

## Testing After Fix

1. Clear browser cache and localStorage
2. Login with supplier credentials
3. Navigate to `/supplier-profile`
4. Check browser console for detailed logs
5. Verify profile loads successfully

## Prevention

To prevent this issue in the future:
1. Implement token refresh mechanism
2. Add token expiration handling
3. Validate token format before storage
4. Add backend token validation logging
5. Create health check endpoints

## Related Files

- Frontend: `frontend/src/pages/suppliers/SupplierProfile.jsx`
- Backend: `backend/services/supplier-service/src/controllers/supplier.controller.js`
- Auth: `backend/services/supplier-service/src/middleware/auth.middleware.js`
- Routes: `backend/services/supplier-service/src/routes/supplier.routes.js`
